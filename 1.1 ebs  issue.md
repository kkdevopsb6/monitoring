# Prometheus & Alertmanager on AWS EKS – PVC Pending Issue (Root Cause & Fix)

This document explains a **real-time production issue** faced while installing **Prometheus and Alertmanager on AWS EKS**, where pods remain in **Pending** state due to storage provisioning problems.

---

## Issue Summary

After installing Prometheus using Helm on an EKS cluster:

- Prometheus Server pod is in Pending state
- Alertmanager pod is in Pending state
- PVCs are not getting bound
- Node Exporter and kube-state-metrics are running fine

---

## Observed Symptoms

### Pods Status

```

prometheus-server-xxxxxx           Pending
prometheus-alertmanager-0          Pending

```

### PVC Status

```

prometheus-server                   Pending   StorageClass: gp2
storage-prometheus-alertmanager-0   Pending   StorageClass: gp2

```

### StorageClass

```

gp2 (default)
Provisioner: kubernetes.io/aws-ebs

```

---

## Root Cause Analysis (RCA)

### Problem Identified

The EKS cluster is using the **old in-tree AWS EBS provisioner**:

```

kubernetes.io/aws-ebs

```

However:

- Modern EKS versions (1.24+) **do not support in-tree EBS**
- AWS has fully migrated to **EBS CSI Driver**
- The old gp2 StorageClass cannot dynamically provision volumes

### Expected Provisioner

```

ebs.csi.aws.com

````

---

## Proof of Failure

Running the following command shows the real issue:

```bash
kubectl describe pvc prometheus-server -n monitoring
````

Typical error message:

```
failed to provision volume with StorageClass "gp2"
no volume plugin matched
```

---

## Why Only Some Pods Were Running

| Component          | Uses PVC | Status  |
| ------------------ | -------- | ------- |
| node-exporter      | No       | Running |
| kube-state-metrics | No       | Running |
| Prometheus Server  | Yes      | Pending |
| Alertmanager       | Yes      | Pending |

Only **stateful components** failed due to storage issues.

---

## Correct Fix (Production-Grade Solution)

We must apply **three mandatory fixes**:

1. Install AWS EBS CSI Driver
2. Ensure proper IAM permissions
3. Create CSI-based StorageClass and reinstall Prometheus

---

## Step 1: Install AWS EBS CSI Driver

### Recommended Method (eksctl)

```bash
eksctl create addon \
  --name aws-ebs-csi-driver \
  --cluster <cluster-name> \
  --region ap-south-1
```

Verify installation:

```bash
kubectl get pods -n kube-system | grep ebs
```

Expected pods:

```
ebs-csi-controller
ebs-csi-node
```

---

## Step 2: Verify IAM Permissions

The **worker node IAM role** must have this policy attached:

```
AmazonEBSCSIDriverPolicy
```

Without this policy:

* Volume creation will fail
* PVCs will remain Pending

---

## Step 3: Create CSI-Based StorageClass (gp3)

Create a new StorageClass using CSI driver.

```bash
vi gp3-sc.yaml
```

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gp3
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  fsType: ext4
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

Apply:

```bash
kubectl apply -f gp3-sc.yaml
```

Verify:

```bash
kubectl get sc
```

Expected output:

```
gp3 (default)   ebs.csi.aws.com
```

---

## Step 4: Remove Old Prometheus Installation

PVCs created with the wrong provisioner **must be removed**.

```bash
helm uninstall prometheus -n monitoring
```

Delete old PVCs:

```bash
kubectl delete pvc -n monitoring --all
```

---

## Step 5: Reinstall Prometheus

```bash
helm install prometheus prometheus-community/prometheus \
  -n monitoring
```

You may also use `kube-prometheus-stack` if required.

---

## Step 6: Verification (Final Confirmation)

Check PVCs:

```bash
kubectl get pvc -n monitoring
```

Expected:

```
STATUS: Bound
STORAGECLASS: gp3
```

Check pods:

```bash
kubectl get pods -n monitoring
```

Expected:

```
prometheus-server        Running
prometheus-alertmanager  Running
```

---

## Interview-Ready Explanation

“In AWS EKS, Prometheus and Alertmanager require persistent storage. The issue occurred because the default gp2 StorageClass was using the deprecated in-tree aws-ebs provisioner. Since modern EKS supports only the EBS CSI driver, PVCs remained in Pending state. We fixed this by installing the AWS EBS CSI driver, attaching the AmazonEBSCSIDriverPolicy to worker nodes, creating a CSI-based gp3 StorageClass, and reinstalling Prometheus. After that, PVCs bound successfully and all pods started running.”

---

## Key Takeaways

* EBS CSI Driver is mandatory for EKS
* In-tree aws-ebs provisioner is deprecated
* Always use CSI-based StorageClass (gp3 recommended)
* PVC issues are the most common cause of Prometheus pod failures on EKS
* Node Exporter works without storage, Prometheus does not

---

